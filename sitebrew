#!/usr/bin/env perl
use 5.012;
use strict;
use warnings;
use File::Find;
use Text::Markdown qw(markdown);
use IO::All -utf8;
use YAML;

sub build_markdown {
    my ($markdown_file) = @_;
    system "sitebrew-one", $markdown_file;
}

sub build_all {
    find +{
        wanted => sub {
            return if !-f || /\.DS_Store/ || /\.git/ || $File::Find::dir =~ /(sass|\.git)/;

            if (/\.md\z/s) {
                build_markdown($File::Find::name);
            }
            else {
                my $dest = $File::Find::name;
                if ($dest =~ s/^content/public/) {

                    unless ( io->file($dest)->exists && io->file($dest)->mtime > io($_)->mtime ) {
                        say "$File::Find::name => $dest";
                        io($File::Find::name) > io->file($dest)->assert->print("");
                    }
                }
            }
        },
        no_chdir => 1
    }, "content";

    say 'DONE';
}

if (@ARGV && $ARGV[0] eq '--watch') {
    use File::ChangeNotify;
    my $watcher = File::ChangeNotify->instantiate_watcher(
        directories => ['content', 'layouts'],
        filter      => qr/\.(html|md|tx)$/
    );

    while (my @events = $watcher->wait_for_events() ) {
        say("+-+ " . $_->path) for (@events);
        build_all;
    }
}
else {
    build_all;
}
